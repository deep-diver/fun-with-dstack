type: task

python: "3.11"

nodes: 2

env:
  - FT_MODEL_CONFIG_PATH
  - ACCEL_CONFIG_PATH

  - HUGGING_FACE_HUB_TOKEN
  - WANDB_API_KEY

commands:
  - echo $DSTACK_MASTER_NODE_IP
  - echo $DSTACK_NODE_RANK
  - echo $DSTACK_GPUS_NUM
  - echo $DSTACK_NODES_NUM

  - conda install cuda
  - git clone https://github.com/huggingface/alignment-handbook.git
  - mkdir -p alignment-handbook/recipes/custom/
  - cp "$FT_MODEL_CONFIG_PATH" alignment-handbook/recipes/custom/config.yaml
  - cp "$ACCEL_CONFIG_PATH" alignment-handbook/recipes/custom/accel_config.yaml

  - cd alignment-handbook
  - python -m pip -q install .
  - python -m pip install -q flash-attn --no-build-isolation

  - pip install -q wandb
  - wandb login $WANDB_API_KEY

  - ACCELERATE_LOG_LEVEL=info accelerate launch 
      --config_file recipes/custom/accel_config.yaml 
      --main_process_ip=$DSTACK_MASTER_NODE_IP 
      --main_process_port=8008 
      scripts/run_sft.py recipes/custom/config.yaml
ports:
  - 6006
  
resources:
  gpu: 1..2
  shm_size: 24GB
